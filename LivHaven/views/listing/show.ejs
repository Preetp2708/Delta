<% layout('/layouts/boilerplate') -%>

<body style="background-color: #f4e3ce; font-family: 'Inter', sans-serif;">
  <div class="container py-5">

    <!-- Listing Card -->
    <div class="card shadow-lg mx-auto mb-5 border-0" style="max-width: 700px; border-radius: 16px; overflow: hidden;">
      <% if (listing.image && listing.image.url) { %>
        <img src="<%= listing.image.url %>" 
             class="card-img-top" 
             alt="<%= listing.title %>" 
             style="height: 300px; object-fit: cover;">
      <% } %>

      <div class="card-body p-4">
        <h1 class="card-title text-primary fw-bold mb-3"><%= listing.title %></h1>
        <h5 class="text-muted mb-4"><%= listing.description %></h5>

        <ul class="list-group list-group-flush mb-4 small">
          <li class="list-group-item px-0 bg-transparent border-0">
            ğŸ’° Price: <strong>&#8377; <%= listing.price.toLocaleString("en-IN") %></strong>
          </li>
          <li class="list-group-item px-0 bg-transparent border-0">
            ğŸ“ Location: <%= listing.location %>
          </li>
          <li class="list-group-item px-0 bg-transparent border-0">
            ğŸŒ Country: <%= listing.country %>
          </li>
          <li class="list-group-item px-0 bg-transparent border-0">
            ğŸ•’ Created At: <%= listing.createdAt.toLocaleString() %>
          </li>
          <li class="list-group-item px-0 bg-transparent border-0">
            ğŸ§‘â€ğŸ’¼ Owner: <%= listing.owner ? listing.owner.username : 'Unknown' %>
          </li>
        </ul>

        <% if(currentUser && currentUser._id.equals(listing.owner._id)) {%>
          <!-- Action Buttons -->
        <div class="d-flex justify-content-center gap-3 mt-4">
          <a href="/listing/<%= listing._id %>/edit" class="btn btn-warning btn-lg rounded-pill shadow-sm px-4">
            âœï¸ Edit
          </a>
          <form action="/listing/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline">
            <button type="submit" class="btn btn-danger btn-lg rounded-pill shadow-sm px-4">
              ğŸ—‘ï¸ Delete
            </button>
          </form>
        </div>
          <% } %>
      </div>
    </div>

    <!-- Review Form -->
    <div class="card shadow-sm mx-auto p-4 border-0" style="max-width: 500px; border-radius: 16px;">
      <h5 class="text-primary fw-bold mb-3 text-center">Leave a Review</h5>
      <form action="/listing/<%= listing._id %>/reviews" method="POST">

        <!-- Rating Slider -->
        <div class="d-flex align-items-center mb-3">
          <label for="reviewRating" class="me-3 mb-0 fw-semibold">Rating:</label>
          <input 
            type="range" 
            class="form-range flex-grow-1" 
            id="reviewRating" 
            name="review[rating]" 
            min="1" 
            max="5" 
            step="1" 
            value="3"
            oninput="document.getElementById('ratingValue').innerText = this.value" 
            style="height: 4px;">
          <span class="ms-2 fw-bold text-primary" id="ratingValue">3</span>
        </div>

        <!-- Comment Box -->
        <textarea 
          class="form-control mb-3 shadow-sm" 
          id="reviewComment" 
          name="review[comment]" 
          rows="3" 
          placeholder="Write your review..." 
          required></textarea>
        <!-- Submit Button -->
        <div class="text-end">
          <button type="submit" class="btn btn-success btn-sm rounded-pill px-4 shadow-sm">
            âœ… Submit
          </button>
        </div>
      </form>
    </div>
    <hr>
    <h4 class="text-primary fw-bold mb-4 text-center">Reviews</h4>
    <div class="row g-4 justify-content-center">
      <% if (listing.reviews && listing.reviews.length > 0) { %>
        <% listing.reviews.forEach(review => { %>
          <div class="col-md-6">
            <div class="card shadow-sm h-100 border-0" style="border-radius: 12px;">
              <div class="card-body">
                <h5 class="card-title text-primary fw-bold mb-2">Rating: <span class="text-warning"><i class="fa-regular fa-star"></i> <%= review.rating %></span></h5>
                <p class="card-text text-muted"><%= review.comment %></p>
                <form action="/listing/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="d-inline">
                  <button type="submit" class="btn btn-danger btn-sm rounded-pill px-3 shadow-sm">
                    ğŸ—‘ï¸ Delete
                  </button>
                </form>
              </div>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <p class="text-muted">No reviews yet.</p>
      <% } %>
    </div>
  </div>
</body>
